
import pyautogui
import pandas as pd
import tkinter as tk
from tkinter import ttk
import json, os, time

# === CONFIG ===
POINT_FILE = "points.json"
CSV_PATH = r"C:\Downloads\data.csv"
CLICK_DELAY = 0.05
POINT_TYPES = ["Name", "Email", "Address", "Phone", "Submit"]

points = {}

# === Load saved points if available ===
if os.path.exists(POINT_FILE):
    with open(POINT_FILE, "r") as f:
        points = json.load(f)

# === Overlay UI ===
root = tk.Tk()
root.title("Click Mapper")
root.attributes("-fullscreen", True)
root.attributes("-alpha", 0.3)
root.configure(bg="gray")
root.attributes("-topmost", True)

tk.Label(root, text="Click to record points.\nPress ESC to quit.",
         font=("Arial", 16), bg="gray", fg="white").pack(pady=20)

# Dropdown to select point type
selected_type = tk.StringVar(value=POINT_TYPES[0])
dropdown = ttk.Combobox(root, values=POINT_TYPES, textvariable=selected_type, state="readonly", width=20)
dropdown.pack(pady=10)

# Status label
status_label = tk.Label(root, text="", font=("Arial", 14), bg="gray", fg="white")
status_label.pack(pady=10)

def record_click(event):
    ptype = selected_type.get()
    coords = (event.x_root, event.y_root)
    points[ptype] = coords
    status_label.config(text=f"{ptype} set at {coords}")
    print(f"{ptype} = {coords}")

def save_and_exit(event=None):
    with open(POINT_FILE, "w") as f:
        json.dump(points, f, indent=2)
    print("Points saved:", points)
    root.destroy()

root.bind("<Button-1>", record_click)
root.bind("<Escape>", save_and_exit)
root.mainloop()

# === RUN PHASE ===
print("Loaded points:", points)
if not points:
    print("No points defined.")
    exit()

# === Load CSV ===
df = pd.read_csv(CSV_PATH)

print("Automation starting in 3 seconds...")
time.sleep(3)

for i, row in df.iterrows():
    # Example: You can use each field type dynamically
    for key in POINT_TYPES:
        if key in points and key in row:
            x, y = points[key]
            pyautogui.click(x, y)
            pyautogui.typewrite(str(row[key]))
            time.sleep(CLICK_DELAY)

    # Click submit at the end of each row if configured
    if "Submit" in points:
        pyautogui.click(*points["Submit"])
        time.sleep(CLICK_DELAY)
